---
title: "TMP"
author: "Angga Fathan Rofiqy"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  rmdformats::downcute:
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: true
    highlight: tango
    code_folding: show
    toc_depth: 3
    number_sections: false
    toc_float:
      collapsed: true
      smooth_scroll: true
    fig_caption: true
pkgdown:
  as_is: true
---

```{r setup, include=FALSE, echo=FALSE, warning=FALSE, message = FALSE}
path <- function() gsub  ( "\\\\",  "/",  readClipboard ()  )

require("knitr")
opts_knit$set(root.dir = "C:/Users/Fathan/Documents/Obsidian Vault/2. Kuliah/Smt 6/2. Teknik Pembelajaran Mesin/Project/Kuliah Tugas Individu 1")

#                      -=( Install & Load Package Function )=-
install_load <- function (package1, ...)  {   

   # convert arguments to vector
   packages <- c(package1, ...)

   # start loop to determine if each package is installed
   for(package in packages){

       # if package is installed locally, load
       if(package %in% rownames(installed.packages()))
          do.call('library', list(package))

       # if package is not installed locally, download, then load
       else {
          install.packages(package)
          do.call("library", list(package))
       }
   } 
}

#install.packages("tensorflow")
#install.packages("keras")

#library("reticulate")
#virtualenv_create("r-reticulate2", python = install_python())
#tensorflow::install_tensorflow()
#keras::install_keras()

# Delete Installation
#wunlink("~/.virtualenvs/r-tensorflow", recursive = TRUE)

install_load("DT","dplyr","ggplot2","gridExtra","MASS","neuralnet","tensorflow"
             ,"keras","caret","lattice")
```

# Pendahuluan

## Deskripsi Tugas

Suatu perusahaan perbank-kan meneliti 75 jenis skema pinjaman yang telah diberi rating oleh para customernya pada `data ann.csv`.

Variabel yang digunakan ialah:

-   Besar pinjaman (dalam juta rupiah)

-   Lama pembayaran (dalam tahun)

-   Tambahan bunga yang ditetapkan (dalam %)

-   Pembayaran per bulan (dalam 10000)

-   Banyak cash back yang diterapkan pada skema tersebut

**Tujuan** penelitian yang dilakukan ialah **memprediksi rating skema pinjaman** berdasarkan variabel-variabel tersebut. Bantulah peneliti tersebut untuk memprediksi reating skema pinjaman dengan **neural network**, hitunglah **RMSE prediksinya**.

> **Ketentuan Tugas**

-   Gunakan **data ann.csv**

-   Kerjakan prediksi rating skema pinjaman dengan neural network, hitunglah RMSE prediksinya

-   Kirimkan kode R beserta output dan interpretasinya pada file dengan format pdf

-   Batas waktu pengiriman adalah **Hari Senin, tanggal 26 Februari 2024 jam 13:00 WIB** 

## Data

```{r}
data <- read.csv("data ann.csv")
#Data Type
str(data)
```

Semua peubah merupakan peubah numerik, tidak ada yang perlu diubah.

## Missing Value

```{r}
colSums(is.na(data))
```

Terlihat bahwa tidak ada missing value.

## Splitting Data & Scaling

Data perlu dilakukan scaling, agar skala dari setiap peubah sama.

```{r}
set.seed(123)

# Train-Testing Split
train.index <- createDataPartition(data$rating, p = 0.8, list = F)
train <- data[train.index, ]
test <- data[-train.index, ]

# Feature Scaling (Min-Max)
preprocessParams <- preProcess(train[, -ncol(data)], method = "range")
train_X <- as.matrix(predict(preprocessParams, train[, -ncol(data)]))
test_X <- as.matrix(predict(preprocessParams, test[, -ncol(data)]))

train_y <- train[, ncol(data), drop = FALSE]  
test_y <- test[, ncol(data), drop = FALSE]    
```

# Model 

```{r}
# Arsitektur Model
model <- keras_model_sequential() %>%
  layer_dense(units = 64, activation = "relu", input_shape = ncol(train_X)) %>%
  layer_dense(units = ncol(train_y), activation = "softmax")

# Kompilasi Model
model %>% compile(
  loss = "categorical_crossentropy",
  optimizer = "adam",
  metrics = c("accuracy")
)

print(model)
```

```{r}
# Training Model
history <- model %>% fit(
  train_X, train_y,
  shuffle = T,
  epochs = 100,
  batch_size = 32, 
  validation_split = 0.2
)
```

```{r}
# Evaluasi Model dengan data Test
scores <- model %>% evaluate(test_X, test_y)
```

```{r}
print(scores)
```

```{r dpi=300, fig.height = 15, fig.width = 20, fig.align = "center", message = FALSE, warning=FALSE}
# Memisahkan data menjadi data latih dan data uji (80% data latih, 20% data uji)
set.seed(123)  # untuk reproducibility
sample_index <- sample(1:nrow(data), 0.8 * nrow(data))
train_data <- data[sample_index, ]
test_data <- data[-sample_index, ]

# Membangun model neural network
# Anda dapat menyesuaikan jumlah hidden layer dan neuron sesuai kebutuhan
model <- neuralnet(rating ~ besar.pinjaman + lama.pembayaran + bunga + 
                     pembayaran.per.bulan + banyak.cash.back,
                   data = train_data, hidden = c(5, 3), linear.output = TRUE)
plot(model)

# Melakukan prediksi pada data uji
predicted <- predict(model, test_data)

# Menghitung RMSE
rmse <- sqrt(mean((predicted - test_data$rating)^2))
print(paste("RMSE:", rmse))
```

```{r dpi=300, fig.height = 15, fig.width = 20, fig.align = "center", message = FALSE, warning=FALSE}
# Build the neural network model with modifications
model <- neuralnet(rating ~ besar.pinjaman + lama.pembayaran + bunga + pembayaran.per.bulan + banyak.cash.back,
                   data = train_data_norm, hidden = c(10, 5), linear.output = TRUE,
                   act.fct = "logistic", algorithm = "backprop", learningrate = 0.01, 
                   err.fct = "sse", threshold = 0.01)

# Make predictions on the test data
predicted <- predict(model, test_data_norm)

# Inverse normalization of predicted values
predicted_denorm <- predicted * (max(data$rating) - min(data$rating)) + min(data$rating)

# Calculate RMSE
rmse <- sqrt(mean((predicted_denorm - test_data_norm$rating)^2))
print(paste("RMSE:", rmse))

```
