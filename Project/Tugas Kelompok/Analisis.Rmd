---
title: "Tugas Akhir TPM"
author: "Angga Fathan Rofiqy"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  rmdformats::downcute:
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: true
    highlight: tango
    code_folding: hide
    toc_depth: 3
    number_sections: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    fig_caption: true
pkgdown:
  as_is: true
---

```{r setup, include=FALSE, echo=FALSE, warning=FALSE, message = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
#                      -=( Install & Load Package Function )=-
install_load <- function (package1, ...)  {   

   # convert arguments to vector
   packages <- c(package1, ...)

   # start loop to determine if each package is installed
   for(package in packages){

       # if package is installed locally, load
       if(package %in% rownames(installed.packages()))
          do.call('library', list(package))

       # if package is not installed locally, download, then load
       else {
          install.packages(package)
          do.call("library", list(package))
       }
   } 
}

path <- function() gsub  ( "\\\\",  "/",  readClipboard ()  )

install_load("readxl","ggplot2","dplyr","DT","cowplot","factoextra","mclust","psych")

export.chart <- "C:/Users/Fathan/Documents/Obsidian Vault/2. Kuliah/Smt 6/2. Teknik Pembelajaran Mesin/Project/Tugas Kelompok/Chart"
```

```{r , include=FALSE, echo=FALSE, warning=FALSE, message = FALSE}
#Set Working Directory
require("knitr")
opts_knit$set(root.dir = "C:/Users/Fathan/Documents/Obsidian Vault/2. Kuliah/Smt 6/2. Teknik Pembelajaran Mesin/Project/Tugas Kelompok")
```

# Data

## Input Data

```{r}
raw.data <- read.csv("Data.csv"); data <- raw.data
colnames(data) <- c("Prov","X1","X2",'X3','X4','X5','X6','X7')
kode <- read.csv("Kode Provinsi.csv")

datatable(raw.data,  options = list(pageLength = 5))
```

## Check Data

> **Cek tipe data**

```{r}
str(raw.data)
```

> **Cek data hilang**

```{r}
colSums(is.na(raw.data))
```

Tidak ada data hilang pada setiap kolom.

## Eksplorasi data {.tabset}

### Sebaran data

```{r fig.height=15, fig.width=30, dpi=300}
colors <- c("#0f2c3a","#357a87","#6ec1c1","#a9ded7","#9a3b1a","#ce572b","#e9865b")
titles <- c("\nX1 - UHH","\nX2 - Puskesmas","\nX3 - Imun","\nX4 - Tenaga Medis",
            "\nX5 - BPJS", "\nX6 - Sanitasi","\nX7 - Sumber Air")
bin <- c(.8, 85, 10, 700, 7, 5, 6)
all_plots <- list()

for (i in 1:(ncol(data)-1) ) {
  plots <- list()
  
  # Histogram with density plot
  p1 <- ggplot(data, aes(x = data[,1+i] )) +
    geom_histogram(aes(y = ..density.., weight=data[,1+i] ), 
                   binwidth = bin[i], 
                   fill = colors[i], color = "black", lwd=1) +
    geom_density(color = "black", lwd=2, fill = colors[i], alpha = .5) +
    ylab("Density") + theme_void() +
    xlab(colnames(data[,1+i])[i]) 
  
  # Boxplot
  p2 <- ggplot(data, aes(y = data[,1+i] )) +
    geom_boxplot(fill = colors[i], color = "black", 
                 outlier.size = 3, lwd=1, alpha=.5) +
    xlab("Nilai") + theme_set(theme_void() + theme(axis.text.x = element_text())) + 
    coord_flip()
  
  # Gabung plot
  combined_plot <- plot_grid(p1, p2, ncol = 1, align = 'v', 
                             rel_heights = c(1, 0.15))
  
  # Menambahkan judul utama
  title <- ggdraw() + 
    draw_label(titles[i], fontface = 'bold', x = 0.5, 
               hjust = 0.5, size = 30)
  
  # Menampilkan plot dengan judul utama
  plots <- 
  plot_grid(title, combined_plot, ncol = 1, rel_heights = c(0.1, 1))
  
  all_plots[[i]] <- plots
}
chart <-
plot_grid(plotlist = all_plots, ncol=4)
chart

#Export Chart
ggsave("Sebaran Data.png", chart, path = export.chart,
        dpi = 300, height = 15, width = 30)
```

Terdapat beberapa variabel dengan range yang kecil yaitu UHH(X1) dan Sumber Air(X7), yang artinya untuk variabel-variabel tersebut tidak jauh berbeda di tiap provinsinya.

-   Sebaliknya terdapat variabel-variabel dengan range sangat besar (dapat dilihat dari nilai Max. dan Min.) seperti variabel Puskesmas(X2) dan Tenaga Medis(X4).

-   Dari informasi diatas dapat diketahui bahwa tiap provinsi memiliki karakteristik tersendiri, maka dari itu provinsi-provinsi akan diklasterkan berdasarkan kemiripan dari karakteristiknya.

> **Hubungan antar peubah**

```{r fig.height=5, fig.width=10, dpi=300}
# Standarisasi Data
dt <- scale(data[,-1])
# Korelasi
pairs.panels(dt,
             method = "pearson", # correlation method
             hist.col = "#00AFBB", #Coloring histogram
             density = TRUE,  # show density plots
             ellipses = TRUE, # show correlation ellipses
             smooth = TRUE, #show loess smooths
             pch = 20, #Scatter = cirlce / dot
             rug = TRUE, #Rug under histogram
             stars = TRUE #Significance of corr
             )
```

# Clustering

## GMM

### Banyaknya Cluster

> **Pemilihan banyak culster**

```{r}
# GMM clustering dengan mclust
gmm_model <- Mclust(dt)

gmm_model$BIC
```

```{r fig.height=5, fig.width=10, dpi=300}
# Menampilkan hasil BIC untuk berbagai jumlah cluster
plot(gmm_model, what = "BIC")
```

```{r}
optimal_clusters <- gmm_model$G
cat("Optimal number of clusters: ", optimal_clusters, "\n")
```

Juumlah culster optimal adalah 2, ini bisa dilihat dengan mncari titik dengan nilai BIC terbesar. Dalam kasus ini niali BIC terbesar adalah model EVE dengan jumlah komponen 2.

> **Summary Jumlah Cluster optimal**

```{r}
gmm_model2 = Mclust(dt, G = 2, modelNames = c("EVE"))
summary(gmm_model2, parameters = TRUE)
```

```{r}
# Menghitung frekuensi observasi di setiap kluster
cluster_frequencies <- table(gmm_model2$classification)

# Mengurutkan kluster berdasarkan frekuensinya
sorted_clusters <- names(sort(cluster_frequencies, decreasing = TRUE))

# Membuat urutan kluster yang diinginkan (1, 2, 3, 4, 5)
new_order <- 1:length(sorted_clusters)

# Menukar isi kluster dengan urutan yang dihasilkan
gmm_model2$classification <- recode(gmm_model2$classification, 
                               !!!setNames(as.character(new_order), sorted_clusters))

table(gmm_model2$classification)
```

> **Plot culster**

```{r}
fviz_cluster(gmm_model2, data = dt, repel = TRUE, labelsize =8)
```

### Cluster Profil

```{r}
data.clust1 <- cbind(dt %>% as.data.frame() %>% mutate(across(everything(), as.numeric)), 
                     Cluster = gmm_model2[["classification"]]) 

# Calculate the mean of each variable for each cluster
cluster_profiles1 <- aggregate(. ~ Cluster, data.clust1, mean)

# Print the cluster profiles
print(cluster_profiles1)
```

```{r}
# Convert the data to long format for plotting
cluster_profiles_long1 <- tidyr::pivot_longer(cluster_profiles1, -Cluster, 
                                             names_to = "Variable", values_to = "Value")

# Create the bar plot
ggplot(cluster_profiles_long1, aes(x = Cluster, y = Value, fill = Variable)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Cluster", y = "Mean Value", fill = "Variable") +
  theme_minimal() +
  ggtitle("Cluster Profiles")
```

```{r dpi=300,  fig.height = 10, fig.width = 10, fig.align = "center", warning=FALSE, message = FALSE}
library(ggiraphExtra)

data.akhir1 <- cbind(raw.data, Cluster =  gmm_model2[["classification"]]) %>% 
  relocate(Cluster, .before = 2)

# Radar Plot
ggRadar(
  data = data.akhir1,
  mapping = aes(colours = Cluster)
) + 
theme_light() +
theme(
  text = element_text(size = 10),  # Mengubah ukuran font global
  title = element_text(size = 12),  # Mengubah ukuran font judul
  axis.text = element_text(size = 10),  # Mengubah ukuran font label sumbu
  legend.text = element_text(size = 8)  # Mengubah ukuran font legenda
)
```

### Map

```{r message=FALSE, warning=FALSE}
install_load("spdep","rgdal")
indo <- st_read(dsn= "C:/Users/Fathan/Documents/Obsidian Vault/2. Kuliah/Smt 5/8. Pengantar Sains Data/Tugas/Tugas Akhir/SHP Indonesia/prov.shp", 
                quiet = TRUE)
```

```{r dpi=300,  fig.height = 9, fig.width = 16, fig.align = "center", warning=FALSE, message = FALSE}
data.map <- cbind(data.clust1, KODE=kode$KODE)
  
data.indo <- indo %>%
  inner_join(data.map, by = c("KODE" = "KODE"))

ggplot() +  
  geom_sf(data=data.indo, aes(fill=factor(`Cluster`))) +
  scale_fill_manual(values=c("1" = "indianred", "2" = "lightgreen", "3" = "dodgerblue",
                             "4"="cyan3", "5"="purple3"), 
                    name = "Keterangan") +
  labs(title = "Analisis Cluster Kesejahteraan \n pada Provinsi Indonesia 2021",
       x = "Longitude",
       y = "Latitude") +
  theme_minimal() +
  theme(legend.text = element_text(size=10),
        legend.title = element_text(size=10, face="bold"),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        plot.title = element_text(size=12, face="bold", hjust = 0.5)) +
  scale_x_continuous(labels = function(x) paste0(x, "°")) +
  scale_y_continuous(labels = function(y) paste0(y, "°"))
```

> **Tampilan Data dengan cluster**

```{r}
datatable(data.akhir1)
#Export data
write.csv(data.akhir1, "data_clust1.csv", row.names = FALSE)
```

```{r fig.height=15, fig.width=30, dpi=300}
colors <- c("1" = "#bf212f", "2" = "#27b376")

# List of variable names (excluding Provinsi and Cluster)
variables <- names(data.akhir1)[!names(data.akhir1) %in% c("Provinsi", "Cluster")]

plots <- list()

for (var in variables) {
  # Sort data based on the current variable
  sorted_data <- data.akhir1 %>%
    arrange(!!sym(var)) %>%
    mutate(Provinsi = factor(Provinsi, levels = Provinsi))
  
  p <- ggplot(sorted_data, aes_string(x = var, y = "Provinsi", fill = "factor(Cluster)")) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = colors) +
    labs(x = var, y = "Provinsi", fill = "Cluster") +
    theme_minimal()
  
  plots[[var]] <- p
}

combined_plot <- plot_grid(plotlist = plots, ncol = 4)
combined_plot
```

## K-Means
