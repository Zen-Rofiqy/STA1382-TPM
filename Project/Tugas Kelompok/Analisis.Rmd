---
title: "Tugas Akhir TPM"
author: "Angga Fathan Rofiqy"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  rmdformats::downcute:
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: true
    highlight: tango
    code_folding: hide
    toc_depth: 3
    number_sections: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    fig_caption: true
pkgdown:
  as_is: true
---

```{r setup, include=FALSE, echo=FALSE, warning=FALSE, message = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
#                      -=( Install & Load Package Function )=-
install_load <- function (package1, ...)  {   

   # convert arguments to vector
   packages <- c(package1, ...)

   # start loop to determine if each package is installed
   for(package in packages){

       # if package is installed locally, load
       if(package %in% rownames(installed.packages()))
          do.call('library', list(package))

       # if package is not installed locally, download, then load
       else {
          install.packages(package)
          do.call("library", list(package))
       }
   } 
}

path <- function() gsub  ( "\\\\",  "/",  readClipboard ()  )

install_load("readxl","ggplot2","dplyr","DT","cowplot","factoextra","mclust"
             ,"psych","cluster","ggiraphExtra","cluster","NbClust")

export.chart <- "C:/Users/Fathan/Documents/Obsidian Vault/2. Kuliah/Smt 6/2. Teknik Pembelajaran Mesin/Project/Tugas Kelompok/Chart"
```

```{r , include=FALSE, echo=FALSE, warning=FALSE, message = FALSE}
#Set Working Directory
require("knitr")
opts_knit$set(root.dir = "C:/Users/Fathan/Documents/Obsidian Vault/2. Kuliah/Smt 6/2. Teknik Pembelajaran Mesin/Project/Tugas Kelompok")
```

# Data

## Input Data

```{r}
raw.data <- read.csv("Data.csv"); data <- raw.data
colnames(data) <- c("Prov","X1","X2",'X3','X4','X5','X6','X7')
kode <- read.csv("Kode Provinsi.csv")

datatable(raw.data,  options = list(pageLength = 5))
```

## Check Kualitas Data

> **Cek tipe data**

```{r}
str(raw.data)
```

> **Cek data hilang**

```{r}
colSums(is.na(raw.data))
```

Tidak ada data hilang pada setiap kolom.

## Eksplorasi data

### Sebaran data

```{r fig.height=15, fig.width=30, dpi=300}
colors <- c("#0f2c3a","#357a87","#6ec1c1","#a9ded7","#9a3b1a","#ce572b","#e9865b")
titles <- c("\nX1 - UHH","\nX2 - Puskesmas","\nX3 - Imun","\nX4 - Tenaga Medis",
            "\nX5 - BPJS", "\nX6 - Sanitasi","\nX7 - Sumber Air")
bin <- c(.8, 85, 10, 700, 7, 5, 6)
all_plots <- list()

for (i in 1:(ncol(data)-1) ) {
  plots <- list()
  
  # Histogram with density plot
  p1 <- ggplot(data, aes(x = data[,1+i] )) +
    geom_histogram(aes(y = ..density.., weight=data[,1+i] ), 
                   binwidth = bin[i], 
                   fill = colors[i], color = "black", lwd=1) +
    geom_density(color = "black", lwd=2, fill = colors[i], alpha = .5) +
    ylab("Density") + theme_void() +
    xlab(colnames(data[,1+i])[i]) 
  
  # Boxplot
  p2 <- ggplot(data, aes(y = data[,1+i] )) +
    geom_boxplot(fill = colors[i], color = "black", 
                 outlier.size = 3, lwd=1, alpha=.5) +
    xlab("Nilai") + theme_set(theme_void() + theme(axis.text.x = element_text())) + 
    coord_flip()
  
  # Gabung plot
  combined_plot <- plot_grid(p1, p2, ncol = 1, align = 'v', 
                             rel_heights = c(1, 0.15))
  
  # Menambahkan judul utama
  title <- ggdraw() + 
    draw_label(titles[i], fontface = 'bold', x = 0.5, 
               hjust = 0.5, size = 30)
  
  # Menampilkan plot dengan judul utama
  plots <- 
  plot_grid(title, combined_plot, ncol = 1, rel_heights = c(0.1, 1))
  
  all_plots[[i]] <- plots
}
chart <-
plot_grid(plotlist = all_plots, ncol=4)
chart

#Export Chart
ggsave("Sebaran Data.png", chart, path = export.chart,
        dpi = 300, height = 15, width = 30)
```

Peubah X2, X4, dan X5 menyebar dengan menjulur ke kanan. Ini bisa dilihat dari density plot dan histogram nya yang menjulur ke kanan, serta dengan adanya outlier di sebelah kanan pada boxplotnya. Artinya mayoritas provinsi memiliki nilai yang jauh lebih sedikit daripada provinsi lainnya. Dalam kasus ini nilai yang dimaksud adalah banyaknya puskesmas, tenaga medis, dan persentase penerima BPJS.

Peubah X3, X6, dan X7 menyebar dengan menjulur ke kiri. Ini bisa dilihat dari density plot dan histogram nya yang menjulur ke kiri, serta dengan adanya outlier di sebelah kiri pada boxplotnya. Artinya masih ada beberapa provinsi yang nilai nya tertinggal jauh dari pada kebanyakan provinsi. Dalam kasus ini nilai yang dimaksud adalah Persentase balita sudah imunisasi dasar lengkap, Persentase rumah tangga dengan sanitasi layak, dan Persentase rumah tangga dengan pelayanan sumber air minum layak.

Sedangkan untuk umur harapan hidup nampak hampir simetris jika dilihat dari histogram, density plot dan boxplot nya. Artinya sebaran UHH di setiap provinsi terdistribusi secara merata di sekitar rata-rata, tanpa ada kemenjuluran yang signifikan ke arah tertentu.

### Sebaran per provinsi

```{r fig.height=15, fig.width=30, dpi=300}
# List of variable names (excluding Provinsi and Cluster)
variables <- names(raw.data)[!names(raw.data) %in% c("Provinsi")]

plots <- list()

for (var in variables) {
  # Sort data based on the current variable
  sorted_data <- raw.data %>%
    arrange(!!sym(var)) %>%
    mutate(Provinsi = factor(Provinsi, levels = Provinsi))
  
  p <- ggplot(sorted_data, aes_string(x = var, y = "Provinsi")) +
    geom_bar(stat = "identity", fill = "#357a87") +
    labs(x = var, y = "Provinsi") +
    theme_minimal()
  
  plots[[var]] <- p
}

combined_plot <- plot_grid(plotlist = plots, ncol = 4)
combined_plot
```

Untuk sebaran lebih detail nya seperti ini. Bisa dilihat bahwa selaras dengan yang sudah diinterpretasikan di plot sebelumnya, bahwa UHH hampir menyebar simetris, lalu X2, X4, dan X5 menyebar dengan menjulur ke kanan yang ditandai banyaknya bar yang kecil, lalu terakhir X3, X6, dan X7 menyebar dengan menjulur ke kiri yang ditandai dengan ada beberapa bar yang ukurannya lebih kecil dari mayoritas.

### Hubungan antar peubah

```{r fig.height=5, fig.width=10, dpi=300}
# Standarisasi Data
dt <- scale(data[,-1])
# Korelasi
pairs.panels(dt,
             method = "pearson", # correlation method
             hist.col = "#00AFBB", #Coloring histogram
             density = TRUE,  # show density plots
             ellipses = TRUE, # show correlation ellipses
             smooth = TRUE, #show loess smooths
             pch = 20, #Scatter = cirlce / dot
             rug = TRUE, #Rug under histogram
             stars = TRUE #Significance of corr
             )
```

Jika kita melihat dari scatterplotnya, maka kita akan melihat bahwa pola hubungan antar peubah itu beragam, ada yang memilki hubungan linear ada juga yang nampaknya tidak meiliki hubungan linear. Jika dihitung hubungan linearnya dengan korelasi pearson, maka kita bisa melihat bahwa mayoritas hubungan antarr peubahnya itu lemah. Hubungan lineaer yang paling kuat adalah hubungan antara peubah X2 dan X4 dengan nilai 0.78. Bisa dilihat juga dari scatterplitnya yang memilki pola lurus positif. Ini didukung dnegan garis LOESS Smooth nya yang paling lurus dan paling 45 derajat diantara yang lain. Juga dari bentuk elips korelasinya yang nampak lancip nan bersudut 45 derajat. Yang mana ini tentu make sense karena Jumlah Puskesmas selaras dengan juumlah tenaga medis yang ada.

### Multikolinearitas

```{r}
CekVIF <- function(data) {
  corr = as.matrix(cor(data))
  VIF = diag(solve(corr))
  
  return(VIF)
}

CekVIF(data[,-1])
```

Pada setiap variabel tidak ada yang memiliki nilai VIF \> 10 sehingga antar variabel tidak terjadi multikolinearitas.

# Clustering

## GMM

### n Cluster Optimum

> **Pemilihan banyak culster**

Pada dasarnya nilai k optimum dapat ditentukan sendiri oleh peneliti, selain itu nilai k dapat ditentukan juga menggunakan bantuan nilai dari setiap sebaran gaussian yang dihasilkan dan dilihat mana yang memiliki nilai BIC terbesar. Tak harus melihat nilai dari sebarannya, ini juga bisa dibuat plot agar mudah untuk menentukan mana jumlah cluster yang optimal.

```{r}
# GMM clustering dengan mclust
gmm_model <- Mclust(dt)

gmm_model$BIC
```

```{r fig.height=5, fig.width=10, dpi=300}
# Menampilkan hasil BIC untuk berbagai jumlah cluster
plot(gmm_model, what = "BIC")
```

```{r}
optimal_clusters <- gmm_model$G
cat("Optimal number of clusters: ", optimal_clusters, "\n")
```

Juumlah culster optimal adalah 2, ini bisa dilihat dengan mncari titik dengan nilai BIC terbesar. Dalam kasus ini niali BIC terbesar adalah model EVE dengan jumlah komponen 2.

### Hasil Clustering

> **Summary Jumlah Cluster optimal**

```{r}
gmm_model2 = Mclust(dt, G = 2, modelNames = c("EVE"))
summary(gmm_model2, parameters = TRUE)
```

> **Proporsi cluster**

```{r}
# Menghitung frekuensi observasi di setiap kluster
cluster_frequencies <- table(gmm_model2$classification)

# Mengurutkan kluster berdasarkan frekuensinya
sorted_clusters <- names(sort(cluster_frequencies, decreasing = TRUE))

# Membuat urutan kluster yang diinginkan (1, 2, 3, 4, 5)
new_order <- 1:length(sorted_clusters)

# Menukar isi kluster dengan urutan yang dihasilkan
gmm_model2$classification <- recode(gmm_model2$classification, 
                               !!!setNames(as.character(new_order), sorted_clusters))

table(gmm_model2$classification)
```

Proporsi jumlah cluster 1 dan 2 adalah 26 : 8.

> **Plot culster**

```{r}
fviz_cluster(gmm_model2, data = dt, repel = TRUE, labelsize =8)
```

Terlihat bahwa GMM tidak membuat cluster berdararkan kedekatan titik, melainkan berdasarkan sebaran berbagai sebaran gaussian.

```{r}
fviz_silhouette(gmm_model2, palette = "jco",
                ggtheme = theme_minimal())
```

### Cluster Profil

```{r}
data.clust1 <- cbind(dt %>% as.data.frame() %>% mutate(across(everything(), as.numeric)), 
                     Cluster = gmm_model2[["classification"]]) 

# Calculate the mean of each variable for each cluster
cluster_profiles1 <- aggregate(. ~ Cluster, data.clust1, mean)

# Print the cluster profiles
print(cluster_profiles1)
```

```{r}
# Convert the data to long format for plotting
cluster_profiles_long1 <- tidyr::pivot_longer(cluster_profiles1, -Cluster, 
                                             names_to = "Variable", values_to = "Value")

# Create the bar plot
ggplot(cluster_profiles_long1, aes(x = Cluster, y = Value, fill = Variable)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Cluster", y = "Mean Value", fill = "Variable") +
  theme_minimal() +
  ggtitle("Cluster Profiles")
```

Terlihat dari nilai yang sudah distandarisasi bahwa profil dari cuslter 2 memilki nilai yang hampir unggul dalam segala peubah dibandingan dengan cluster 1. Notes: adanya nilai negatif karena hasil dari standarisasi memang mengandung nilai positif dan negatif. Agar mudah perbandingannya, mari kita lihat dengan diagram spider web dibawah ini.

```{r dpi=300,  fig.height = 10, fig.width = 10, fig.align = "center", warning=FALSE, message = FALSE}
data.akhir1 <- cbind(raw.data, Cluster =  gmm_model2[["classification"]]) %>% 
  relocate(Cluster, .before = 2)

# Radar Plot
ggRadar(
  data = data.akhir1,
  mapping = aes(colours = Cluster)
) + 
theme_light() +
theme(
  text = element_text(size = 10),  # Mengubah ukuran font global
  title = element_text(size = 12),  # Mengubah ukuran font judul
  axis.text = element_text(size = 10),  # Mengubah ukuran font label sumbu
  legend.text = element_text(size = 8)  # Mengubah ukuran font legenda
)
```

Selaras dengan yang sudah saya sampaikan diatas, bahwa cluster 2 hampir unggul dalam segala aspek. Cluster 1 hanya bisa dunggul dalam sanitasi dan imun saja, sedangkan yang lainnya tidak mampu mengungguli atau bahkan tidak ada harapan untuk mengungguli cluster 2.

### Map

```{r message=FALSE, warning=FALSE}
install_load("spdep","rgdal")
indo <- st_read(dsn= "C:/Users/Fathan/Documents/Obsidian Vault/2. Kuliah/Smt 5/8. Pengantar Sains Data/Tugas/Tugas Akhir/SHP Indonesia/prov.shp", 
                quiet = TRUE)
```

```{r dpi=300,  fig.height = 9, fig.width = 16, fig.align = "center", warning=FALSE, message = FALSE}
data.map <- cbind(data.clust1, KODE=kode$KODE)
  
data.indo <- indo %>%
  inner_join(data.map, by = c("KODE" = "KODE"))

ggplot() +  
  geom_sf(data=data.indo, aes(fill=factor(`Cluster`))) +
  scale_fill_manual(values=c("1" = "indianred", "2" = "lightgreen", "3" = "dodgerblue",
                             "4"="cyan3", "5"="purple3"), 
                    name = "Keterangan") +
  labs(title = "GMM Clustering - Kesejahteraan \n pada Provinsi Indonesia 2021",
       x = "Longitude",
       y = "Latitude") +
  theme_minimal() +
  theme(legend.text = element_text(size=10),
        legend.title = element_text(size=10, face="bold"),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        plot.title = element_text(size=12, face="bold", hjust = 0.5)) +
  scale_x_continuous(labels = function(x) paste0(x, "°")) +
  scale_y_continuous(labels = function(y) paste0(y, "°"))
```

Ada yang aneh? ya memang. Kenapa bisa provinsi papua masuk kedalam cluster 2 yang sebelumnya disebut-sebut sebagai cluster yang unggul dalam segala aspek kesejahteraan. Mari kita telurusi lebih lanjut.

### Anggota Cluster

> **Tampilan Data dengan cluster**

```{r}
datatable(data.akhir1, options = list(pageLength = 5))
#Export data
write.csv(data.akhir1, "data_clust1.csv", row.names = FALSE)
```

Jika anda ingin melihat bagaimana tampilan data dengan cluster nya. Atau lebih mudah dengan bar chart dibawah.

```{r fig.height=15, fig.width=30, dpi=300}
colors <- c("1" = "#bf212f", "2" = "#27b376")

# List of variable names (excluding Provinsi and Cluster)
variables <- names(data.akhir1)[!names(data.akhir1) %in% c("Provinsi", "Cluster")]

plots <- list()

for (var in variables) {
  # Sort data based on the current variable
  sorted_data <- data.akhir1 %>%
    arrange(!!sym(var)) %>%
    mutate(Provinsi = factor(Provinsi, levels = Provinsi))
  
  p <- ggplot(sorted_data, aes_string(x = var, y = "Provinsi", fill = "factor(Cluster)")) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = colors) +
    labs(x = var, y = "Provinsi", fill = "Cluster") +
    theme_minimal()
  
  plots[[var]] <- p
}

combined_plot <- plot_grid(plotlist = plots, ncol = 4)
combined_plot
```

Memang terlihat keanehannya, bahwa salah satu anggota cluster 2 tidak bisa meungguli semua aspek kesejahteraan yang ada. Bahwakan kalah jauh daripada yang lain. Sepertinya memang clustering dengan GMM bukanlah ide yang tepat.

## K-Means

### n Cluster Optimum {.tabset}

Menentukan jumlah klaster paling optimum untuk membagi 34 provinsi yang ada di Indonesia. Pada dasarnya nilai k optimum dapat ditentukan sendiri oleh peneliti, selain itu nilai k dapat ditentukan juga menggunakan bantuan grafik Elbow berikut. Dimana k minimum akan didapat ketika grafik sudah tidak bergerak menurun dengan tajam.

#### Silhouette

```{r}
fviz_nbclust(x = dt, 
             FUNcluster = kmeans,
             method = 'silhouette',
             k.max = 10)
```

Dari hasil diatas didapatkan nilai K optimum adalah 2.

#### Gap Statistic

```{r}
library(cluster)
#calculate gap statistic for each number of clusters (up to 10 clusters)
gap_stat <- clusGap(dt, FUN = hcut, nstart = 25, K.max = 10, B = 50)

#produce plot of clusters vs. gap statistic
fviz_gap_stat(gap_stat)
```

Dari hasil diatas didapatkan nilai K optimum adalah 1.

#### WSS (Elbow)

```{r}
fviz_nbclust(dt, kmeans, method = "wss")
```

Untuk wss nampaknya agak sulit untuk melihat berapa jumlah cluster yang optimumnya, namun nampaknya 6 atau 2 merupakan jumlah cluster optimumnya.

#### Hubert Statistic & Dindex

```{r fig.height=5, fig.width=10, dpi=300}
nb <- NbClust(data = dt, distance = "euclidean", method="complete")
```

Untuk hubert statistic dan dindex, jumlah cluster optimal yang disarankan adalah 2.

### Hasil Clustering 1

Beberapa metode untuk menentukan jumlah cluster memiliki jumlah cluster optimal yang cukup beragam. Namun 2 merupakan jumlah cluster yang nampaknya bisa diterima oleh semua metode yang ada. Sehingga jumlah cluster yang akan dicobakan adalah 2.

```{r message=FALSE, warning=FALSE}
set.seed(100)

data_kmeans <- eclust(dt, "kmeans", k = 2, graph = FALSE)
fviz_cluster(object = data_kmeans, data=dt)
```

> **Proporsi cluster**

```{r}
table(data_kmeans$cluster)
```

Proporsi jumlah cluster 1 dan 2 adalah 27 : 7.

#### Validasi Cluster

> **Silhouette**

```{r}
fviz_silhouette(data_kmeans, palette = "jco",
                ggtheme = theme_minimal())
```

Karena pengamatan dengan nilai siluet negatif yang dapat dilihat pada cluster 1 yang berwarna biru pada plot mengindikasikan bahwa pengamatan tersebut mungkin dikelompokkan secara tidak benar. Mari lihat angka indeks dari pengamatan tersebut.

```{r}
sil <- data_kmeans$silinfo$widths
neg_sil_index <- which(sil[, 'sil_width']<0)
data[neg_sil_index, 1]
```

Terlihat bahwa provinsi papua merupakan provinsi yang mungkin blm dapat dikelompokkan secara benar oleh K-means, mari kita perbaiki.

### Hasil Clustering 2 

Mari kita tambahkan paramter `nstart = 6` untuk menentukan jumlah awalisasi acak yang akan dilakukan oleh algoritma K-means. K-means adalah algoritma yang sensitif terhadap titik awal centroid yang dipilih secara acak. Untuk mengurangi kemungkinan menemukan solusi yang hanya merupakan minimum lokal (bukan global), sering kali beberapa awalizasi acak dilakukan, dan hasil dengan total inersia (atau sum of squared distances from points to their assigned cluster centroids) terkecil dipilih sebagai hasil akhir.

```{r message=FALSE, warning=FALSE}
set.seed(100)

data_kmeans <- eclust(dt, "kmeans", k = 2,
                      nstart = 6, graph = FALSE)
fviz_cluster(object = data_kmeans, data=dt)
```

> **Proporsi cluster**

```{r}
table(data_kmeans$cluster)
```

Proporsi jumlah cluster 1 dan 2 adalah 30 : 4.

#### Validasi Cluster 

> **Silhouette**

```{r}
fviz_silhouette(data_kmeans, palette = "jco",
                ggtheme = theme_minimal())
```

Terlihat bahwa sudah tidak ada pengamatan dengan niali siluet negatif, sehingga seluruh pengamatan dikelompokkan secara tidak benar sudah kemunkinannya sudah kecil.

### Cluster Profil

```{r}
data.clust2 <- cbind(dt %>% as.data.frame() %>% mutate(across(everything(), as.numeric)), 
                     Cluster = data_kmeans$cluster) 

# Calculate the mean of each variable for each cluster
cluster_profiles2 <- aggregate(. ~ Cluster, data.clust2, mean)

# Print the cluster profiles
print(cluster_profiles2)
```

```{r}
# Convert the data to long format for plotting
cluster_profiles_long2 <- tidyr::pivot_longer(cluster_profiles2, -Cluster, 
                                             names_to = "Variable", values_to = "Value")

# Create the bar plot
ggplot(cluster_profiles_long2, aes(x = Cluster, y = Value, fill = Variable)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Cluster", y = "Mean Value", fill = "Variable") +
  theme_minimal() +
  ggtitle("Cluster Profiles")
```

Berlainan dengan hasil dari GMM, cluster 2 merupakan cluster dengan aspek kesejahteraan yang paling tinggi dibandingkan dengan cluster 1. Benar-benar unggul semua. Mari kita lihat lebih jelas dengan radar chart dibawah.

```{r dpi=300,  fig.height = 10, fig.width = 10, fig.align = "center", warning=FALSE, message = FALSE}
data.akhir2 <- cbind(raw.data, Cluster =  data_kmeans$cluster) %>% 
  relocate(Cluster, .before = 2)

# Radar Plot
ggRadar(
  data = data.akhir2,
  mapping = aes(colours = Cluster)
) + 
theme_light() +
theme(
  text = element_text(size = 10),  # Mengubah ukuran font global
  title = element_text(size = 12),  # Mengubah ukuran font judul
  axis.text = element_text(size = 10),  # Mengubah ukuran font label sumbu
  legend.text = element_text(size = 8)  # Mengubah ukuran font legenda
)
```

Sejalan dengan yang saya bilang diatas, bahwa cluster 2 benar-benar mengungguli cluster 1.

### Map

```{r dpi=300,  fig.height = 9, fig.width = 16, fig.align = "center", warning=FALSE, message = FALSE}
data.map <- cbind(data.clust2, KODE=kode$KODE)
  
data.indo <- indo %>%
  inner_join(data.map, by = c("KODE" = "KODE"))

ggplot() +  
  geom_sf(data=data.indo, aes(fill=factor(`Cluster`))) +
  scale_fill_manual(values=c("1" = "indianred", "2" = "lightgreen"), 
                    name = "Keterangan") +
  labs(title = "K-means Clustering -  Kesejahteraan \n pada Provinsi Indonesia 2021",
       x = "Longitude",
       y = "Latitude") +
  theme_minimal() +
  theme(legend.text = element_text(size=10),
        legend.title = element_text(size=10, face="bold"),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        plot.title = element_text(size=12, face="bold", hjust = 0.5)) +
  scale_x_continuous(labels = function(x) paste0(x, "°")) +
  scale_y_continuous(labels = function(y) paste0(y, "°"))
```

Berbeda dengan GMM, hasil dari k-means itu lebih make sense, mari kita lihat keanggotaan clusternya.

### Anggota Cluster

> **Tampilan Data dengan cluster**

```{r}
datatable(data.akhir2, options = list(pageLength = 5))
#Export data
write.csv(data.akhir2, "data_clust2.csv", row.names = FALSE)
```

```{r fig.height=15, fig.width=30, dpi=300}
colors <- c("1" = "#bf212f", "2" = "#27b376")

# List of variable names (excluding Provinsi and Cluster)
variables <- names(data.akhir2)[!names(data.akhir2) %in% c("Provinsi", "Cluster")]

plots <- list()

for (var in variables) {
  # Sort data based on the current variable
  sorted_data <- data.akhir2 %>%
    arrange(!!sym(var)) %>%
    mutate(Provinsi = factor(Provinsi, levels = Provinsi))
  
  p <- ggplot(sorted_data, aes_string(x = var, y = "Provinsi", fill = "factor(Cluster)")) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = colors) +
    labs(x = var, y = "Provinsi", fill = "Cluster") +
    theme_minimal()
  
  plots[[var]] <- p
}

combined_plot <- plot_grid(plotlist = plots, ncol = 4)
combined_plot
```

Bisa dilihat bahwa memang K-Means menghasilkan cluster yang lebih make sense daripada GMM. Karena hampir di semua aspek memang cluster 1 lebih unggul daripada cluster 2.

## Fuzzy C-Means

Untuk FCM pemilihan jumlah clusternya sama dengan K-Means, sehingga jumlah cluster yang akan digunakan adalah 2.

### Hasil Clustering 1

```{r}
# clustering menggunakan fanny()
data_fcm <- fanny(x = dt, k = 2, metric = "euclidean")
fviz_cluster(object = data_fcm, data=dt) 
```

> **Proporsi Cluster**

```{r}
table(data_fcm$cluster)
```

Berbeda dengan 2 metode sebelumnya, FCM menghasilkan proporsi jumlah cluster yang berbeda, yakni lebih proporsional antar clusternya yakni 16 : 18.

#### Validasi Cluster

> **Dunn Index**

```{r}
data_fcm$coeff
```

Nilai Dunn index yang kita peroleh sebesar 0.5, sangat kecil tbh. Untuk mengetahui hasil cluster yang kita bentuk sudah baik berdasarkan nilai Dunn index yaitu dengan mendapatkan Dunn index yang semakin besar.

Kita perlu mengetahui berapa banyak cluster yang terbentuk dari nilai derajat keanggotaan yang ada.

> **Pengelompokkan**

```{r}
data_fcm$clustering %>% unique()
```

Dari hasil pengelompokan menjadi 2 kelompok, ternyata 2 kelompok tersebut berhasil terisi. Artinya bahwa dengan menggunakan k=2, fuzzy c-means mampu menseparasikan data berdasarkan 2 kelompok yang berbeda. Sehingga juumlah cluster 2 merupakan jumlah cluster yang sudah tepat.

> **Silhouette**

```{r}
fviz_silhouette(data_fcm, palette = "jco",
                ggtheme = theme_minimal())
```

Karena pengamatan dengan nilai siluet negatif yang dapat dilihat pada cluster 1 yang berwarna biru pada plot mengindikasikan bahwa pengamatan tersebut mungkin dikelompokkan secara tidak benar. Mari lihat angka indeks dari pengamatan tersebut.

```{r}
sil <- data_fcm$silinfo$widths
neg_sil_index <- which(sil[, 'sil_width']<0)
data[neg_sil_index, 1]
```

Terlihat bahwa 7 provinsi tersebut merupakan provinsi yang mungkin blm dapat dikelompokkan secara benar oleh FCM. Mari kita perbaiki.

### Hasil Cluster 2

```{r}
data_fcm <- fanny(x = dt, k = 2, metric = "manhattan", memb.exp = 3)
fviz_cluster(object = data_fcm, data=dt) 
```

> **Proporsi Cluster**

```{r}
table(data_fcm$cluster)
```

Berbeda dengan 2 metode sebelumnya, FCM menghasilkan proporsi jumlah cluster yang berbeda, yakni lebih proporsional antar clusternya yakni 19 : 15.

#### Validasi Cluster

> **Dunn Index**

```{r}
data_fcm$coeff
```

Nilai Dunn index yang kita peroleh masih sebesar 0.5.

Dari hasil pengelompokan menjadi 2 kelompok, ternyata 2 kelompok tersebut berhasil terisi. Artinya bahwa dengan menggunakan k=2, fuzzy c-means mampu menseparasikan data berdasarkan 2 kelompok yang berbeda. Sehingga juumlah cluster 2 merupakan jumlah cluster yang sudah tepat.

Kita perlu mengetahui berapa banyak cluster yang terbentuk dari nilai derajat keanggotaan yang ada.

> **Pengelompokkan**

```{r}
data_fcm$clustering %>% unique()
```

Dari hasil pengelompokan menjadi 2 kelompok, ternyata 2 kelompok tersebut berhasil terisi. Artinya bahwa dengan menggunakan k=2, fuzzy c-means mampu menseparasikan data berdasarkan 2 kelompok yang berbeda. Sehingga juumlah cluster 2 merupakan jumlah cluster yang sudah tepat.

```{r}
fviz_silhouette(data_fcm, palette = "jco",
                ggtheme = theme_minimal())
```

Masih ada pengamatan dengan nilai siluet negatif yang dapat dilihat pada cluster 1 yang berwarna kuning pada plot mengindikasikan bahwa pengamatan tersebut mungkin dikelompokkan secara tidak benar. Mari lihat angka indeks dari pengamatan tersebut.

```{r}
sil <- data_fcm$silinfo$widths
neg_sil_index <- which(sil[, 'sil_width']<0)
data[neg_sil_index, 1]
```

Terlihat bahwa 3 provinsi tersebut merupakan provinsi yang mungkin blm dapat dikelompokkan secara benar oleh FCM. Namun saya rasa, saya sudah mencoba berbagai hal untuk memperbaikinya, dan ini adalah hasil terbaik dari FCM. Jadi ya, kita sudahi.

### Cluster Profil

```{r}
data.clust3 <- cbind(dt %>% as.data.frame() %>% mutate(across(everything(), as.numeric)), 
                     Cluster = data_fcm$cluster) 

# Calculate the mean of each variable for each cluster
cluster_profiles3 <- aggregate(. ~ Cluster, data.clust3, mean)

# Print the cluster profiles
print(cluster_profiles3)
```

```{r}
# Convert the data to long format for plotting
cluster_profiles_long3 <- tidyr::pivot_longer(cluster_profiles3, -Cluster, 
                                             names_to = "Variable", values_to = "Value")

# Create the bar plot
ggplot(cluster_profiles_long3, aes(x = Cluster, y = Value, fill = Variable)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Cluster", y = "Mean Value", fill = "Variable") +
  theme_minimal() +
  ggtitle("Cluster Profiles")
```

Dari sini kita tahu bahwa cluster 1 dan cluster 2 cenderung memiliki bentuk bar yang mirip namun kebalik. Tidak tahu pasti apa artinya, namun cluster 2 merupakan cluster yang lebih unggul dalam segala aspek daripada cluster 1. Mari kita lihat radar chart nya.

```{r dpi=300,  fig.height = 10, fig.width = 10, fig.align = "center", warning=FALSE, message = FALSE}
data.akhir3 <- cbind(raw.data, Cluster =  data_fcm$cluster) %>% 
  relocate(Cluster, .before = 2)

# Radar Plot
ggRadar(
  data = data.akhir3,
  mapping = aes(colours = Cluster)
) + 
theme_light() +
theme(
  text = element_text(size = 10),  # Mengubah ukuran font global
  title = element_text(size = 12),  # Mengubah ukuran font judul
  axis.text = element_text(size = 10),  # Mengubah ukuran font label sumbu
  legend.text = element_text(size = 8)  # Mengubah ukuran font legenda
)
```

Selaras dengan yang saya sampaikan di atas, bawahwa cluster 1 dan cluster 2 memang mirip, namun cluster 2 memiliki nilai yang lebih besar daripada cluster 1.

### Map

```{r dpi=300,  fig.height = 9, fig.width = 16, fig.align = "center", warning=FALSE, message = FALSE}
data.map <- cbind(data.clust3, KODE=kode$KODE)
  
data.indo <- indo %>%
  inner_join(data.map, by = c("KODE" = "KODE"))

ggplot() +  
  geom_sf(data=data.indo, aes(fill=factor(`Cluster`))) +
  scale_fill_manual(values=c("1" = "indianred", "2" = "lightgreen"), 
                    name = "Keterangan") +
  labs(title = "FCM Clustering -  Kesejahteraan \n pada Provinsi Indonesia 2021",
       x = "Longitude",
       y = "Latitude") +
  theme_minimal() +
  theme(legend.text = element_text(size=10),
        legend.title = element_text(size=10, face="bold"),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        plot.title = element_text(size=12, face="bold", hjust = 0.5)) +
  scale_x_continuous(labels = function(x) paste0(x, "°")) +
  scale_y_continuous(labels = function(y) paste0(y, "°"))
```

Beginilah penampakan dari hasil clustering FCM. Apakah lebih bagus daripada metode yang lain? Mari kita pastikan dengan melihat keanggotaan clusternya.

### Anggota Cluster

> **Tampilan Data dengan cluster**

```{r}
datatable(data.akhir3, options = list(pageLength = 5))
#Export data
write.csv(data.akhir3, "data_clust1.csv", row.names = FALSE)
```

```{r fig.height=15, fig.width=30, dpi=300}
colors <- c("1" = "#bf212f", "2" = "#27b376")

# List of variable names (excluding Provinsi and Cluster)
variables <- names(data.akhir3)[!names(data.akhir3) %in% c("Provinsi", "Cluster")]

plots <- list()

for (var in variables) {
  # Sort data based on the current variable
  sorted_data <- data.akhir3 %>%
    arrange(!!sym(var)) %>%
    mutate(Provinsi = factor(Provinsi, levels = Provinsi))
  
  p <- ggplot(sorted_data, aes_string(x = var, y = "Provinsi", fill = "factor(Cluster)")) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = colors) +
    labs(x = var, y = "Provinsi", fill = "Cluster") +
    theme_minimal()
  
  plots[[var]] <- p
}

combined_plot <- plot_grid(plotlist = plots, ncol = 4)
combined_plot
```

Walaupun dalam validasi cluster dengan metode siluet masih ada yang bernilai negatif, namun saya rasa metode FCM mampu membuat cluster yang jauh lebih baik daripada yang lainnya. Tidak seperti K-means yang pada profil nya seolah berkata bahwa cluster 2 itu jauh lebih baik daripada cluster 1 di segala aspek. Namun pada saat kita tampilkan sebaran tiap peubah pada semua provinsi nya, cluster 2 tidak selalu berada di puncak.

Sedangkan untuk FCM itu sesuai dengan apa yang dikatakan oleh profil nya. Yakni clsuter 1 dan cluster 2 itu mirip, namun cluster 2 lebih tinggi daripada cluster 1. Ini juga sesuai dengan sebaran yang kita lihat di atas.

# Referensi

-   [**Validasi Cluster**](https://medium.com/@ozturkfemre/unsupervised-learning-in-r-cluster-validation-8c691ce37784){.uri}

-   [**Clustering**](http://www.sthda.com/english/wiki/wiki.php?id_contents=7952){.uri}

-   <https://rpubs.com/inayatus/fuzzy-c-means>

-   <https://rpubs.com/Anoe/lbb-kmeans>

-   
